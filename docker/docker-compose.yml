version: "3.9"

services:
  activemq:
    image: apache/activemq-classic:5.19.0
    container_name: activemq
    ports:
      - "61616:61616"
      - "8161:8161"
    networks:
      - bigdata
    restart: always

  ingest:
    build: ./ingest
    env_file: .env
    environment:
      - MAIN_CLASS=bigdatastage3.IngestAPI
      - BROKER_URL=tcp://activemq:61616
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7001/status"]
      interval: 10s
      retries: 5
      start_period: 5s
      timeout: 5s
    networks:
      - bigdata
    depends_on:
      - activemq
    restart: always

  index-worker:
    build: ./index
    env_file: .env
    environment:
      - MAIN_CLASS=bigdatastage3.IndexingServiceApp
      - BROKER_URL=tcp://activemq:61616
      - MONGO_URI=${MONGO_URI}
    networks:
      - bigdata
    depends_on:
      - activemq
    restart: always

  search:
    build: ./search
    env_file: .env
    environment:
      - MAIN_CLASS=bigdatastage3.SearchAPI
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7003/status"]
      interval: 10s
      retries: 5
      start_period: 5s
      timeout: 5s
    networks:
      - bigdata
    restart: always

  controller:
    build: ./controller
    container_name: controller
    env_file: .env
    environment:
      - MAIN_CLASS=bigdatastage3.ControllingUnit
      - SEARCH_API=http://nginx:80
      - INGEST_API=http://ingest:7001
    networks:
      - bigdata
    restart: always
    ports:
      - "7000:7000"   # Controller REST-Endpunkte f√ºr Nutzer
    depends_on:
      - ingest
      - activemq

  nginx:
    image: nginx:1.29.4
    container_name: load_balancer
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - search
    networks:
      - bigdata

networks:
  bigdata:
    driver: bridge
